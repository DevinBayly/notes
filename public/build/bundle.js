var app=function(){"use strict";function e(){}function t(e){return e()}function n(){return Object.create(null)}function o(e){e.forEach(t)}function i(e){return"function"==typeof e}function l(e,t){return e!=e?t==t:e!==t||e&&"object"==typeof e||"function"==typeof e}function a(e,t){e.appendChild(t)}function s(e){return document.createElement(e)}function r(){return e=" ",document.createTextNode(e);var e}function c(e,t,n,o){return e.addEventListener(t,n,o),()=>e.removeEventListener(t,n,o)}function d(e,t,n){null==n?e.removeAttribute(t):e.getAttribute(t)!==n&&e.setAttribute(t,n)}function h(e,t,n,o){e.style.setProperty(t,n,o?"important":"")}let u;function p(e){u=e}const m=[],g=[],f=[],y=[],v=Promise.resolve();let b=!1;function w(e){f.push(e)}let x=!1;const S=new Set;function k(){if(!x){x=!0;do{for(let e=0;e<m.length;e+=1){const t=m[e];p(t),C(t.$$)}for(m.length=0;g.length;)g.pop()();for(let e=0;e<f.length;e+=1){const t=f[e];S.has(t)||(S.add(t),t())}f.length=0}while(m.length);for(;y.length;)y.pop()();b=!1,x=!1,S.clear()}}function C(e){if(null!==e.fragment){e.update(),o(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(w)}}const E=new Set;function L(e,t){-1===e.$$.dirty[0]&&(m.push(e),b||(b=!0,v.then(k)),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function T(l,a,s,r,c,d,h=[-1]){const m=u;p(l);const g=a.props||{},f=l.$$={fragment:null,ctx:null,props:d,update:e,not_equal:c,bound:n(),on_mount:[],on_destroy:[],before_update:[],after_update:[],context:new Map(m?m.$$.context:[]),callbacks:n(),dirty:h};let y=!1;var v,b;f.ctx=s?s(l,g,(e,t,...n)=>{const o=n.length?n[0]:t;return f.ctx&&c(f.ctx[e],f.ctx[e]=o)&&(f.bound[e]&&f.bound[e](o),y&&L(l,e)),t}):[],f.update(),y=!0,o(f.before_update),f.fragment=!!r&&r(f.ctx),a.target&&(a.hydrate?f.fragment&&f.fragment.l(function(e){return Array.from(e.childNodes)}(a.target)):f.fragment&&f.fragment.c(),a.intro&&((v=l.$$.fragment)&&v.i&&(E.delete(v),v.i(b))),function(e,n,l){const{fragment:a,on_mount:s,on_destroy:r,after_update:c}=e.$$;a&&a.m(n,l),w(()=>{const n=s.map(t).filter(i);r?r.push(...n):o(n),e.$$.on_mount=[]}),c.forEach(w)}(l,a.target,a.anchor),k()),p(m)}var $,j,I="AIzaSyAIYCyk2KaSfTyX67jJuNKYo-AZAtwwZ-U",A=["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];function D(){gapi.client.init({apiKey:I,clientId:"541857836176-ooorj15vavsg5e0h0c98jodmp5lt39js.apps.googleusercontent.com",discoveryDocs:A,scope:"https://www.googleapis.com/auth/drive"}).then((function(){gapi.auth2.getAuthInstance().isSignedIn.listen(P),P(gapi.auth2.getAuthInstance().isSignedIn.get()),$.onclick=q,j.onclick=O}),(function(e){_(JSON.stringify(e,null,2))}))}function P(e){e?($.style.display="none",j.style.display="block",gapi.client.drive.files.list({pageSize:10,fields:"nextPageToken, files(id, name)"}).then((function(e){_("Files:");var t=e.result.files;if(t&&t.length>0)for(var n=0;n<t.length;n++){var o=t[n];_(o.name+" ("+o.id+")"),"notes.json"==o.name&&(B=o.id)}else _("No files found.")}))):($.style.display="block",j.style.display="none")}function q(e){gapi.auth2.getAuthInstance().signIn()}function O(e){gapi.auth2.getAuthInstance().signOut()}function _(e){var t=document.getElementById("content"),n=document.createTextNode(e+"\n");t.appendChild(n)}let B;let M=()=>{let e='--uploadboundary\nContent-Disposition:form-data;name="metadata";filename="first"\nContent-Type: application/json; charset=UTF-8\n\n{"name":"notes.json","mimeType":"application/json"}\n',t=`--uploadboundary\nContent-Disposition:form-data;name="file";filename="blob"\nContent-Type: application/json\n\n${JSON.stringify({starting:"text"})}\n--uploadboundary--\n    `;fetch(`https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&api=${I}&fields=id`,{method:"POST",headers:{"Content-type":"multipart/related; boundary=uploadboundary","Content-Length":(e+t).length,Authorization:"Bearer "+gapi.auth.getToken().access_token},body:e+t}).then(e=>e.json()).then(e=>console.log(e))},N=()=>fetch(`https://www.googleapis.com/drive/v3/files/${B}/?key=${I}&alt=media`,{}),R=e=>{B?(console.log("updating"),(e=>{let t='--uploadboundary\nContent-Disposition:form-data;name="metadata";filename="first"\nContent-Type: application/json; charset=UTF-8\n\n{"name":"notes.json","mimeType":"application/json"}\n',n=`--uploadboundary\nContent-Disposition:form-data;name="file";filename="blob"\nContent-Type: application/json\n\n${JSON.stringify(e)}\n--uploadboundary--`;fetch(`https://www.googleapis.com/upload/drive/v3/files/${B}/?uploadType=multipart&key=${I}&fields=id`,{method:"PATCH",headers:{"Content-type":"multipart/related; boundary=uploadboundary","Content-Length":(t+n).length,Authorization:"Bearer "+gapi.auth.getToken().access_token},body:t+n}).then(e=>e.json()).then(e=>console.log(e))})(e)):(console.log("creating anew"),M())};function X(t){let n,i,l,u,p,m,g,f,y,v,b,w,x,S,k,C,E,L,T;return{c(){n=s("div"),i=s("p"),i.textContent="Drive API Quickstart",l=r(),u=s("button"),u.textContent="creatfile",p=r(),m=s("button"),m.textContent="makenew",g=r(),f=s("button"),f.textContent="getfile",y=r(),v=s("button"),v.textContent="Authorize",b=r(),w=s("button"),w.textContent="Sign Out",x=r(),S=s("pre"),k=r(),C=s("div"),C.innerHTML='<canvas id="the-canvas"></canvas>',E=r(),L=s("canvas"),d(v,"id","authorize_button"),h(v,"display","none"),d(w,"id","signout_button"),h(w,"display","none"),d(S,"id","content"),h(S,"white-space","pre-wrap"),d(C,"id","pdfcontainer"),d(L,"id","canvas")},m(e,t){!function(e,t,n){e.insertBefore(t,n||null)}(e,n,t),a(n,i),a(n,l),a(n,u),a(n,p),a(n,m),a(n,g),a(n,f),a(n,y),a(n,v),a(n,b),a(n,w),a(n,x),a(n,S),a(n,k),a(n,C),a(n,E),a(n,L),T=[c(u,"click",R),c(m,"click",M),c(f,"click",N)]},p:e,i:e,o:e,d(e){var t;e&&(t=n).parentNode.removeChild(t),o(T)}}}let Y=[];class F{constructor(e,t=""){let[n,o]=e;this.element=document.createElement("textarea"),this.element.style.position="absolute",this.element.style.left=n+"px",this.element.style.top=o+"px",this.element.value=t,this.element.style.width="200px",this.element.style.height="200px"}init(){document.body.append(this.element),this.element.focus(),this.element.selectionEnd+=2,this.keyactions()}mouseup(e){let t=this.func;document.body.removeEventListener("mousemove",t)}mousedown(e){console.log("down ");let t=this.element.getBoundingClientRect();if(e.pageX-(t.left+window.scrollX)<t.width/2){this.startx=e.pageX,this.starty=e.pageY,console.log("down ",this.startx,this.starty);let t=e=>{this.mousemove(e)};document.body.addEventListener("mousemove",t),this.func=t}}mousemove(e){let t=e.pageX,n=e.pageY,o=t-this.startx,i=n-this.starty;this.startx=t,this.starty=n,this.element.style.left=parseFloat(this.element.style.left)+o+"px",this.element.style.top=parseFloat(this.element.style.top)+i+"px"}keyactions(){this.element.addEventListener("mousedown",this.mousedown.bind(this)),this.element.addEventListener("mouseup",this.mouseup.bind(this)),this.element.addEventListener("keydown",e=>{if("ArrowUp"==e.key&&this.imageob.shiftup(),"ArrowDown"==e.key&&this.imageob.shiftdown(),"ArrowRight"==e.key&&(this.pdfob.page+=1,this.pdfob.loadPage(this.pdfob.page)),"ArrowLeft"==e.key&&(this.pdfob.page-=1,this.pdfob.loadPage(this.pdfob.page)),"Enter"==e.key){let t=this.element.selectionStart,n=this.element.value.slice(0,t).split("\n").slice(-1)[0],o=/^\s*/.exec(n)[0];this.element.value=this.element.value.slice(0,t)+"\n"+o+this.element.value.slice(t),this.element.selectionStart=t+1+o.length,this.element.selectionEnd=this.element.selectionStart,e.preventDefault()}if("Control"==e.key&&(this.control=!0),"Alt"==e.key&&(e.preventDefault(),this.check()),"Tab"==e.key){e.preventDefault();let t=this.element.selectionStart;this.element.value=this.element.value.slice(0,t)+"  "+this.element.value.slice(t),this.element.selectionStart=t+2,this.element.selectionEnd=t+2}e.key}),this.element.addEventListener("keyup",e=>{"Control"==e.key&&(this.control=!1)})}calcHeight(){let e=Math.max(...this.element.value.split("\n").map(e=>e.length));this.element.style.width=(8*e+30>150?150:8*e+30)+"px",this.element.style.height=this.element.scrollHeight+"px"}check(){if(console.log("checking"),/-write-/.exec(this.element.value)&&(this.element.value=this.element.value.replace(/-write-/,""),fetch("http://localhost:8040",{method:"POST",body:JSON.stringify({operation:"-savefile-",contents:this.filename+"\n"+this.element.value})})),/-file-/.exec(this.element.value)&&(this.element.value=this.element.value.replace(/-file-/,""),this.filename=this.element.value,fetch("http://localhost:8040",{method:"POST",body:JSON.stringify({operation:"-file-",contents:this.element.value})}).then(e=>e.text()).then(e=>{this.element.value=e})),/-loadimg .* -/.exec(this.element.value)){let e=this.element.value.match(/-loadimg (.*) -/)[1];this.imageob=(()=>{let e={ep:null,create:t=>{let n=new Image;n.src=t,n.onload=()=>{e.holder=document.querySelector("#pdfcontainer"),e.holder.style.overflow="scroll",e.holder.style.height="500px",e.holder.append(n)}},page:0,shiftup:()=>{e.page-=1,e.topCalc=e.holder.getBoundingClientRect().height*e.page,e.holder.scrollTop=e.topCalc,e.ep()},shiftdown:()=>{e.page+=1,e.topCalc=e.holder.getBoundingClientRect().height*e.page,e.holder.scrollTop=e.topCalc,e.ep()}};return e})(),this.imageob.create(e);let t=()=>{let e=this.element.value.split("\n");/-top/.exec(e.slice(-1)[0])&&(e.pop(),this.element.value=e.join("\n")),this.element.value+=`\n-top${this.imageob.topCalc}-`;let t=document.querySelector("#pdfcontainer");document.querySelector("#pdfcontainer").style.position="absolute",document.querySelector("#pdfcontainer").style.left=parseFloat(this.element.style.left)-t.getBoundingClientRect().width+"px"};this.imageob.ep=t}if(/-loadpdf.* -/.exec(this.element.value)){let e=this.element.value.match(/-loadpdf(.*?) -/)[1];this.element.value=this.element.value.replace(/-loadpdf.*? -/,e),(async()=>{let e={ep:null};return e.create=async t=>{let n=document.createElement("script");n.src="https://cdn.jsdelivr.net/npm/pdfjs-dist@2.3.200/build/pdf.min.js",document.body.append(n),e.pdfData=await fetch(`https://www.googleapis.com/drive/v3/files/${t}/?key=AIzaSyAIYCyk2KaSfTyX67jJuNKYo-AZAtwwZ-U&alt=media`).then(e=>e.arrayBuffer()),e.pdfjsLib=window["pdfjs-dist/build/pdf"],e.pdfjsLib.disableWorker=!0,e.pdf=e.pdfjsLib.getDocument({data:e.pdfData}).promise,e.holder=document.querySelector("#pdfcontainer");let o=document.createElement("button");o.innerHTML="left",o.style.position="relative",o.style.left="0px",o.style.bottom="0px",o.addEventListener("click",()=>{e.page-=1,e.loadPage(e.page)});let i=document.createElement("button");i.style.position="relative",i.style.right="0px",i.style.bottom="0px",i.innerHTML="right",i.addEventListener("click",()=>{e.page+=1,e.loadPage(e.page)}),e.holder.append(o),e.holder.append(i)},e.loadPage=t=>{e.page=parseInt(t),e.pdf.then(n=>{console.log("PDF loaded"),n.getPage(parseInt(t)).then((function(t){console.log("Page loaded");var n=t.getViewport({scale:1}),o=document.getElementById("the-canvas"),i=o.getContext("2d");o.height=n.height,o.width=n.width;var l={canvasContext:i,viewport:n};t.render(l).promise.then((function(){console.log("Page rendered")})),e.ep()}))})},e})().then(t=>{this.pdfob=t,this.pdfob.create(e);this.pdfob.ep=()=>{let e=this.element.value.split("\n");/-page/.exec(e.slice(-1)[0])&&(e.pop(),this.element.value=e.join("\n")),this.element.value+=`\n-page${this.pdfob.page}-`};let n=document.querySelector("#pdfcontainer");document.querySelector("#pdfcontainer").style.position="absolute",document.querySelector("#pdfcontainer").style.left=parseFloat(this.element.style.left)-n.getBoundingClientRect().width+"px",document.querySelector("#pdfcontainer").style.top=parseFloat(this.element.style.top)-n.getBoundingClientRect().height+"px"})}if(/-page\d+-/.exec(this.element.value.slice(this.element.startSelection,this.element.endSelection))){let e=this.element.value.slice(this.element.startSelection,this.element.endSelection).match(/-page(\d+)-/)[1];this.pdfob.loadPage(e);let t=document.querySelector("#pdfcontainer");document.querySelector("#pdfcontainer").style.position="absolute",document.querySelector("#pdfcontainer").style.left=parseFloat(this.element.style.left)-t.getBoundingClientRect().width+"px"}if(/-date-/.exec(this.element.value)&&(this.element.value=this.element.value.replace(/-date-/,JSON.stringify(new Date))),/-start-/.exec(this.element.value)&&(this.element.value=this.element.value.replace(/-start-/,"-running-"),this.begin=new Date,this.timeout=setTimeout(()=>{new Notification("20 mins passed")},12e5)),/-stop-/.exec(this.element.value)){this.end=new Date,this.element.value=this.element.value.replace(/-stop-/,"");let e=`${(new Date).toUTCString()}: ${((this.end.getTime()-this.begin.getTime())/6e4).toFixed(3)}`;this.element.value=this.element.value.replace(/-running-/,e);this.element.selectionStart;clearTimeout(this.timeout)}if(/-tex-/.exec(this.element.value)){let e=this.element;fetch("http://localhost:8040/",{method:"POST",body:JSON.stringify({operation:"-latex-",contents:this.element.value.replace(/-tex-/,"")})}).then(t=>{let n=new Image;n.onload=()=>{let t=e.getBoundingClientRect();document.querySelector("canvas").getContext("2d").drawImage(n,t.x+t.width,t.y+t.height)},fetch("./image.png").then(e=>e.blob()).then(e=>{n.src=URL.createObjectURL(e)})})}}timer(){}}class J{constructor(){N().then(e=>e.json()).then(e=>{JSON.parse(e).map(e=>{new F([Math.abs(e.x),Math.abs(e.y)],e.value).init()})})}}class U{constructor(){let e=document.querySelector("canvas"),t=new Image;t.onload=()=>{let n=e.getContext("2d");e.width=t.width,e.height=t.height,n.drawImage(t,0,0)},fetch("/retrieve/background").then(e=>e.text()).then(e=>{t.src=e})}}class H{constructor(){this.btn=document.createElement("button"),this.btn.innerHTML="load all",document.body.prepend(this.btn),this.btn.addEventListener("click",()=>{this.load()})}load(){fetch("/all").then(e=>e.json()).then(e=>{this.select=document.createElement("select");for(let t of e){let e=document.createElement("option");e.value=""+t.id,e.innerHTML=`${t.size},${t.ctime}`,this.select.append(e)}document.body.prepend(this.select),this.select.onchange=()=>{this.select.value;fetch("/idfetch",{method:"POST",headers:{"Content-Type":"text/plain","Content-Length":this.select.value.length},body:this.select.value}).then(e=>e.json()).then(e=>{e.map(e=>{new F([Math.abs(e.x),Math.abs(e.y)],e.value).init()})})}})}}class z{constructor(){this.btn=document.createElement("button"),document.body.prepend(this.btn),this.btn.addEventListener("click",()=>{this.load()}),this.btn.id="reload",this.btn.innerHTML="Load prev data"}load(){new U,new J}}class K{constructor(){this.btn=document.createElement("button"),this.btn.innerHTML="Download",this.btn.id="download",this.btn.addEventListener("click",()=>{let e=this.retrieveInfo();R(JSON.stringify(e));document.querySelector("canvas").toDataURL()}),document.body.prepend(this.btn)}retrieveInfo(){return Array(...document.querySelectorAll("textarea")).map(e=>{let t=e.getBoundingClientRect();return{x:t.x+window.scrollX,y:t.y+window.scrollY,value:e.value}})}}const Z=new class extends class{$destroy(){!function(e,t){const n=e.$$;null!==n.fragment&&(o(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}(this,1),this.$destroy=e}$on(e,t){const n=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return n.push(t),()=>{const e=n.indexOf(t);-1!==e&&n.splice(e,1)}}$set(){}}{constructor(e){super(),T(this,e,null,X,l,{})}}({target:document.body,props:{name:"world"}});return window.onload=()=>{$=document.getElementById("authorize_button"),j=document.getElementById("signout_button"),gapi.load("client:auth2",D),(()=>{Notification.requestPermission();let e=document.querySelector("#canvas");e.width=8e3,e.height=8e3;let t=e.getContext("2d"),n=(new K,new z,new H,()=>{let n=t.getImageData(0,0,e.width,e.height);e.width+=500,e.height+=500,t.fillStyle="#f9d899",t.fillRect(0,0,e.width,e.height),t.putImageData(n,0,0)}),o=!1,i=[0,0];document.body.addEventListener("keydown",l=>{let a={scrollx:window.scrollX,scrolly:window.scrollY},s=e=>{null==a.initialx&&(a.initialx=e.clientX,a.initialy=e.clientY),window.scrollTo(a.scrollx+2*(a.initialx-e.clientX),a.scrolly+4*(a.initialy-e.clientY))};if("Shift"==l.key&&e.addEventListener("mousemove",s),"p"==l.key&&o){let e=new Image;e.onload=()=>{t.drawImage(e,i[0],i[1])},fetch("./image.png").then(e=>e.blob()).then(t=>{e.src=URL.createObjectURL(t)})}"N"==l.key&&o&&(o=!1,new F(i).init(),l.preventDefault());let r=t=>{"Shift"==t.key&&(e.removeEventListener("mousemove",s),e.removeEventListener("keyup",r),(window.scrollX+50>window.scrollMaxX||window.scrollY+50>window.scrollMaxY)&&n())};document.body.addEventListener("keyup",r)});let l=e=>{i[0]=e.pageX,i[1]=e.pageY};e.addEventListener("mousemove",l);let a=[];e.addEventListener("mousedown",i=>{e.removeEventListener("mousemove",l),o=!0;let s=e.getBoundingClientRect(),r=i.clientX-s.left,c=i.clientY-s.topj,d=t=>{let o=e.getBoundingClientRect(),i=t.clientX-o.left,l=t.clientY-o.top;a.push(Math.round(i)),a.push(Math.round(l)),(i+50>e.width||l+50>e.height)&&n()};a.push(Math.round(r)),a.push(Math.round(c)),e.addEventListener("mousemove",d);let h=n=>{t.moveTo(a[0],a[1]),t.beginPath();for(let e=2;e<a.length;e+=2)t.lineTo(a[e],a[e+1]);t.stroke(),Y=Y.concat(a),Y.push(0),a=[],e.removeEventListener("mousemove",d),e.removeEventListener("mouseup",h),e.addEventListener("mousemove",l)};e.addEventListener("mouseup",h)}),document.querySelector("#reload").click()})()},Z}();
//# sourceMappingURL=bundle.js.map
